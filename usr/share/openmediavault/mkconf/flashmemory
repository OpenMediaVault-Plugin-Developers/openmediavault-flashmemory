#!/bin/sh
#
# Copyright (C) 2015 OpenMediaVault Plugin Developers
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

FS2RAM_CONFIG="/etc/fs2ram/fs2ram.conf"
HOUSEKEEPER="/tmp/fs2ramhousekeeper"
XPATH="//services/flashmemory"

# Generate configuration only if the service is enabled.
if [ "$(omv_config_get "${XPATH}/enable")" != "1" ]; then
    exit 0
fi

# Info used from forum thread
# http://forums.openmediavault.org/index.php/Thread/6438-Tutorial-Experimental-Reducing-OMV-s-disk-writes-also-to-install-it-on-USB-flash/?pageNo=1

# create fs2ram config
cat <<EOF > ${FS2RAM_CONFIG}
# this file was automatically generated
#<file system>  <mount point>               <script>                <script option> <type>  <options>
tmpfs           /var/cache                  keep_file_content       -               tmpfs
tmpfs           /var/log                    keep_file_structure     -               tmpfs
tmpfs           /var/tmp                    -                       -               tmpfs
tmpfs           /var/lib/openmediavault/rrd keep_file_content       -               tmpfs
tmpfs           /var/spool                  keep_file_content       -               tmpfs
tmpfs           /var/lib/rrdcached/         keep_file_content       -               tmpfs
tmpfs           /var/lib/monit              keep_file_content       -               tmpfs
tmpfs           /var/lib/php5               keep_folder_structure   -               tmpfs
EOF

#sending a housekeeping script to /tmp so that we do the following modifications in a moment that won't upset apt-get
cat <<EOF > ${HOUSEKEEPER}
#!/bin/bash
#waiting for the package manager to finish its job.
    while [[ ! -f /var/lib/dpkg/lock ]]; do
    sleep 1
    done
#disabling apt disk cache so its folder in /var/cache/apt/whatever will stop filling up. Also saves additional writes.
    echo Dir::Cache ""; > /etc/apt/apt.conf.d/02nocache 
    echo Dir::Cache::archives ""; >> /etc/apt/apt.conf.d/02nocache
#disabling cron-apt package download by erasing the file asking for it.
    rm /etc/cron-apt/action.d/3-download
#deleting the packages already in the cache, because otherwise this is all wasted space in the tmpfs 
#and time wasted on startup and shutdown as all this stuff is compressed/extracted, especially for devices with weak processors
    rm /var/cache/apt/archives/*
    rm /var/cache/apt/archives/partial/*
#script self-destruct, deletes this script from disk. technically optional, as /tmp content gets dumped anyway on startup.
    rm ${HOUSEKEEPER}
exit 0
EOF

#making it executable
chmod a+x ${HOUSEKEEPER}

#calling it up as another process, so this script can quit and installation of whatever else can continue.
bash ${HOUSEKEEPER}

exit 0
