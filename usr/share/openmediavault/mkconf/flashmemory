#!/bin/sh
#
# Copyright (C) 2015 OpenMediaVault Plugin Developers
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

FOLDER2RAM_CONFIG="/etc/folder2ram/folder2ram.conf"
HOUSEKEEPER="/tmp/folder2ramhousekeeper"
XPATH="//services/flashmemory"

# Generate configuration only if the service is enabled.
if [ "$(omv_config_get "${XPATH}/enable")" != "1" ]; then
    exit 0
fi

# Info used from forum thread
# http://forums.openmediavault.org/index.php/Thread/6438-Tutorial-Experimental-Reducing-OMV-s-disk-writes-also-to-install-it-on-USB-flash/?pageNo=1
# now modified by bobafetthotmail to run with folder2ram, a safe and better system based on the info here
# https://www.debian-administration.org/article/661/A_transient_/var/log 

# create folder2ram config
cat <<EOF > ${FOLDER2RAM_CONFIG}
#############################
#folder2ram main config file#
#############################
#
#PROTIP: to make /var/lock or /tmp available as ram filesystems, 
#        it is preferable to set the variables RAMTMP, RAMLOCK
#        in /etc/default/tmpfs.
#
#FILE SYSTEM: does nothing, will be implemented in the future. (everything goes to tmpfs for now)
#
#OPTIONS: does nothing, will be implemented in the future.
#<file system>  <mount point>                 <options>
#tmpfs           /var/cache                 #this folder will be activated later after testing is completed
tmpfs           /var/log                    
tmpfs           /var/tmp                    
tmpfs           /var/lib/openmediavault/rrd 
tmpfs           /var/spool                  
tmpfs           /var/lib/rrdcached/         
tmpfs           /var/lib/monit              
#tmpfs           /var/lib/php5               keep_folder_structure   # folder2ram does not have an equivalent yet

#this file was automatically generated by openmediavault-flashmemory plugin
EOF

#sending a housekeeping script to /tmp so that we do the following modifications in a moment that won't upset apt-get
cat <<EOF > ${HOUSEKEEPER}
#!/bin/bash
#waiting for the package manager to finish its job.
    while [[ ! -f /var/lib/dpkg/lock ]]; do
    sleep 1
    done
#disabling apt disk cache so its folder in /var/cache/apt/whatever will stop filling up. Also saves additional writes.
    echo Dir::Cache ""; > /etc/apt/apt.conf.d/02nocache 
    echo Dir::Cache::archives ""; >> /etc/apt/apt.conf.d/02nocache
#disabling cron-apt package download by erasing the file asking for it.
    rm /etc/cron-apt/action.d/3-download
#deleting the packages already in the cache, because otherwise this is all wasted space in the tmpfs 
#and time wasted on startup and shutdown as all this stuff is compressed/extracted, especially for devices with weak processors
    rm /var/cache/apt/archives/*
    rm /var/cache/apt/archives/partial/*
#script self-destruct, deletes this script from disk. technically optional, as /tmp content gets dumped anyway on startup.
    rm ${HOUSEKEEPER}
exit 0
EOF

#making it executable
chmod a+x ${HOUSEKEEPER}

#calling it up as another process, so this script can quit and installation of whatever else can continue.
bash ${HOUSEKEEPER}

exit 0
