#!/bin/sh
#
# Copyright (C) 2015-2018 OpenMediaVault Plugin Developers
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

FOLDER2RAM_CONFIG="/etc/folder2ram/folder2ram.conf"
TAB="$(printf '\t')"

# Original plugin from info here:
# http://forums.openmediavault.org/index.php/Thread/6438-Tutorial-Experimental-Reducing-OMV-s-disk-writes-also-to-install-it-on-USB-flash/?pageNo=1
# now running with folder2ram instead, written based on the info here
# https://www.debian-administration.org/article/661/A_transient_/var/log

# create directories that may not exist
mkdir -p /var/lib/openmediavault/rrd /var/lib/netatalk/CNID /var/cache/samba

# create folder2ram config
cat > ${FOLDER2RAM_CONFIG} <<'EOF'
#################################################################################
#folder2ram main config file, autogenerated by openmediavault flashmemory plugin#
#################################################################################
#
#PROTIP: to make /var/lock or /tmp available as ram filesystems,
#        it is preferable to set the variables RAMTMP, RAMLOCK
#        in /etc/default/tmpfs.
#
#TYPE: options available are "tmpfs" (for a ram folder)
#
<<<<<<< HEAD
#OPTIONS: ignored for tmpfs, path to local dir for localdir entries.
#
#IMPORTANT: use 2 Tabs to separate "type" from "mount point" from "options", the script needs them to read correctly the configuration.
#
#<type>${tab}${tab}<mount point>${tab}${tab}<options>
tmpfs${tab}${tab}/var/log
tmpfs${tab}${tab}/var/tmp
tmpfs${tab}${tab}/var/lib/openmediavault/rrd
tmpfs${tab}${tab}/var/spool
tmpfs${tab}${tab}/var/lib/rrdcached/
tmpfs${tab}${tab}/var/lib/monit
tmpfs${tab}${tab}/var/lib/php${tab}${tab}#keep_folder_structure   folder2ram does not have an equivalent yet
tmpfs${tab}${tab}/var/lib/netatalk/CNID
tmpfs${tab}${tab}/var/cache/samba
=======
#<file system>  <mount point>                 <options>
#tmpfs      /var/cache      #this folder will be activated later after testing is completed
tmpfs       /var/log
tmpfs       /var/tmp
tmpfs       /var/lib/openmediavault/rrd
tmpfs       /var/spool
tmpfs       /var/lib/rrdcached/
tmpfs       /var/lib/monit
tmpfs       /var/lib/php        #keep_folder_structure   folder2ram does not have an equivalent yet
tmpfs       /var/lib/netatalk/CNID
tmpfs       /var/cache/samba
>>>>>>> 8f996cc071b11333d87a4d25df0b910e050dbf35
EOF

#disabling cron-apt package download by erasing the file asking for it.
rm -f /etc/cron-apt/action.d/3-download

#deleting the packages already in the cache, because otherwise this is all wasted space in the tmpfs
#and time wasted on startup and shutdown
rm -fr /var/cache/apt/archives/*
mkdir -p /var/cache/apt/archives/partial

exit 0
